<!DOCTYPE html>
<html>
<head>
    <title>Xycloud Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        /* --- Tema Dasar & Reset --- */
        body, html { background-color: #1a1a1a; color: #fff; margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; -webkit-user-select: none; user-select: none; }
        /* --- Login Gaul --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1f2937, #111827); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; }
        #login-box { background: #2b2b2b; padding: 30px 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; width: 300px; }
        #login-box h2 { margin: 0 0 25px 0; color: #f0f0f0; }
        #login-box input { display: block; margin: 15px auto; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #333; color: #fff; width: 90%; font-size: 16px; }
        #login-box button { padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
        #login-status { color: #ff4d4d; height: 20px; margin-top: 15px; }
        #how-to { color: #aaa; font-size: 12px; margin-top: 20px; cursor: pointer; text-decoration: underline; }
        #footer { color: #777; font-size: 10px; margin-top: 10px; }
        /* Kartu Admin (Animasi Kipas) */
        #admin-cards { margin-top: 40px; display: flex; justify-content: center; perspective: 800px; }
        .card { width: 80px; height: 120px; background: #444; border-radius: 8px; border: 2px solid #555; margin: 0 -15px; transition: transform 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; text-align: center; font-size: 12px; padding: 5px; }
        #admin-cards:hover .card:nth-child(1) { transform: rotateY(20deg) translateX(-30px); }
        #admin-cards:hover .card:nth-child(2) { transform: scale(1.1); z-index: 1; }
        #admin-cards:hover .card:nth-child(3) { transform: rotateY(-20deg) translateX(30px); }

        /* --- Tampilan Streaming --- */
        #stream-container { width: 100%; height: 100%; display: none; justify-content: center; align-items: center; }
        #stream { width: 100%; height: 100%; object-fit: contain; cursor: none; }
        #status { z-index: 101; position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; }
        /* --- Tombol Kontrol & Overlay --- */
        #controls { position: fixed; top: 10px; right: 10px; z-index: 50; display: none; }
        #controls button { width: 45px; height: 45px; border-radius: 50%; border: none; background: rgba(0,123,255,0.7); color: white; font-size: 20px; margin-left: 10px; cursor: pointer; }
        #settings-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 20px 30px; border-radius: 12px; z-index: 300; display: none; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; min-width: 300px; }
        .setting-row label { font-size: 16px; margin-right: 15px; }
        #hidden-input { position: absolute; left: -9999px; top: -9999px; opacity: 0; }
        /* Gamepad Virtual CSS */
        .overlay-button { position: fixed; z-index: 100; background: rgba(80, 80, 80, 0.5); border: 2px solid rgba(255, 255, 255, 0.6); border-radius: 50%; display: none; color: white; font-size: 18px; font-weight: bold; justify-content: center; align-items: center; }
        #joystick-zone { bottom: 20px; left: 20px; width: 150px; height: 150px; border-radius: 50%; }
        #joystick-knob { width: 50px; height: 50px; background: rgba(150, 150, 150, 0.7); border-radius: 50%; position: absolute; top: 50px; left: 50px; }
        #abxy-zone { bottom: 20px; right: 20px; width: 150px; height: 150px; border-radius: 50%; }
        .gamepad-btn { position: absolute; width: 40px; height: 40px; }
        #btn-gamepad-y { top: 10px; left: 50%; transform: translateX(-50%); background-color: #ffc107; }
        #btn-gamepad-x { left: 10px; top: 50%; transform: translateY(-50%); background-color: #007bff; }
        #btn-gamepad-b { right: 10px; top: 50%; transform: translateY(-50%); background-color: #dc3545; }
        #btn-gamepad-a { bottom: 10px; left: 50%; transform: translateX(-50%); background-color: #28a745; }
        .edit-mode .overlay-button { border-style: dashed; cursor: move; }
        /* Lock Horizontal */
        @media (max-width: 800px) and (orientation: portrait) {
            #potrait-lock { display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; color: white; z-index: 500; justify-content: center; align-items: center; text-align: center; }
        }
    </style>
</head>
<body>
    <div id="stream-container">
        <video id="stream" autoplay playsinline></video> 
        <audio id="audio" autoplay></audio>
    </div>
    <div id="fake-cursor"></div>
    <div id="status">Memuat...</div>

    <div id="controls">
        <button id="btn-mode">üëÜ</button>
        <button id="btn-keyboard">‚å®Ô∏è</button>
        <button id="btn-gamepad">üéÆ</button>
        <button id="btn-settings">‚öôÔ∏è</button>
        <button id="btn-fullscreen">‚õ∂</button>
    </div>
    
    <div id="settings-modal">
        <h3>Pengaturan Bos</h3>
        <div class="setting-row">
            <label for="select-quality">Kualitas Stream:</label>
            <select id="select-quality" disabled><option>WebRTC Otomatis</option></select>
        </div>
        <div class="setting-row">
            <label for="btn-edit-layout">Edit Posisi Tombol:</label>
            <button id="btn-edit-layout">Edit</button>
        </div>
        <hr><button id="btn-close-settings" style="width: 100%;">Tutup Bos</button>
    </div>

    <div id="potrait-lock" style="display: none;"><h1>Bro, Puter HP-nya Dulu! (Horizontal)</h1></div>

    <div id="login-overlay">
        <div id="login-box">
            <h2>Xycloud Login</h2>
            <input id="input-id" type="text" placeholder="ID Host">
            <input id="input-pass" type="password" placeholder="Password">
            <button id="btn-join">Gasss!</button>
            <div id="login-status"></div>
            <div id="how-to" onclick="alert('1. Jalankan Xycloud_App.exe di PC lo.\n2. ID & Pass-nya muncul di situ.\n3. Masukin ke sini, klik Gasss!')">Gimana Caranya?</div>
            <div id="footer">Created By XyTeam</div>
        </div>
        <div id="admin-cards">
            <div class="card">Hawkalputra (Project Lead)</div>
            <div class="card">Gemini (AI Co-Pilot)</div>
            <div class="card">XyTeam (Community)</div>
        </div>
    </div>
    
    <input type="text" id="hidden-input">
    <div id="joystick-zone" class="overlay-button"><div id="joystick-knob"></div></div>
    <div id="abxy-zone" class="overlay-button">
        <button id="btn-gamepad-y" class="overlay-button gamepad-btn">Y</button>
        <button id="btn-gamepad-x" class="overlay-button gamepad-btn">X</button>
        <button id="btn-gamepad-b" class="overlay-button gamepad-btn">B</button>
        <button id="btn-gamepad-a" class="overlay-button gamepad-btn">A</button>
    </div>

    <script>
        // --- Deklarasi Elemen (Sama) ---
        const videoElement = document.getElementById("stream");
        const audioElement = document.getElementById("audio");
        const statusElement = document.getElementById("status");
        const loginOverlay = document.getElementById("login-overlay");
        const loginStatus = document.getElementById("login-status");
        const btnJoin = document.getElementById("btn-join");
        const inputId = document.getElementById("input-id");
        const inputPass = document.getElementById("input-pass");
        
        const controlsDiv = document.getElementById("controls");
        const btnFullscreen = document.getElementById("btn-fullscreen");
        const btnSettings = document.getElementById("btn-settings");
        const btnKeyboard = document.getElementById("btn-keyboard");
        const btnMode = document.getElementById("btn-mode");
        const btnGamepad = document.getElementById("btn-gamepad");
        const hiddenInput = document.getElementById("hidden-input");
        const settingsModal = document.getElementById("settings-modal");
        const btnCloseSettings = document.getElementById("btn-close-settings");
        const btnEditLayout = document.getElementById("btn-edit-layout");
        const gamepadButtons = document.querySelectorAll(".gamepad-btn");
        const allOverlays = document.querySelectorAll(".overlay-button");
        const joystickZone = document.getElementById("joystick-zone");
        const joystickKnob = document.getElementById("joystick-knob");

        // --- Variabel WebRTC & Global ---
        let ws; let pc; let inputChannel;
        const wsUrl = `wss://${window.location.host}/ws`;
        const httpUrl = `https://${window.location.host}`;
        let isEditing = false;
        let activeKeys = {};
        let isMobile = ('ontouchstart' in window);
        let inputMode = "touch";
        
        // --- Logika Koneksi (WebRTC) ---
        async function connect() {
            const hostId = inputId.value; const password = inputPass.value;
            if (!hostId || !password) { loginStatus.textContent = "ID/Pass jangan kosong, Bro."; return; }
            loginStatus.textContent = "Nyambungin ke Mak Comblang...";
            
            // Inisialisasi PeerConnection
            pc = new RTCPeerConnection();
            
            // 1. Buat DataChannel untuk Input
            inputChannel = pc.createDataChannel("input_channel");
            inputChannel.onopen = () => { statusElement.textContent = "STREAMING..."; startInputListeners(); };
            
            // 2. Terima Video & Audio Track
            pc.addTransceiver("video", { direction: "recvonly" });
            pc.addTransceiver("audio", { direction: "recvonly" }); // Siap untuk On Mic
            
            pc.ontrack = (event) => {
                if (event.track.kind === "video") { videoElement.srcObject = event.streams[0]; }
                if (event.track.kind === "audio") { audioElement.srcObject = event.streams[0]; console.log("Audio Stream Diterima!"); }
            };

            // 3. ICE Candidate (Penembus Firewall)
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    fetch(`${httpUrl}/ice-candidate`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: hostId, candidate: event.candidate.toJSON() })
                    });
                }
            };

            // 4. Signaling (WebSocket)
            ws = new WebSocket(wsUrl);
            ws.onopen = () => {
                ws.send(JSON.stringify({ action: "join_viewer", id: `viewer_${Math.random().toString(16).substr(2, 8)}`, host_id: hostId, password: password }));
            };

            ws.onmessage = async (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === "success") {
                    loginStatus.textContent = "Sukses! Nunggu 'Offer' dari Host...";
                } else if (msg.type === "offer") {
                    await pc.setRemoteDescription(new RTCSessionDescription(msg));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    
                    fetch(`${httpUrl}/answer`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: hostId, sdp: answer.sdp, type: answer.type })
                    });
                    
                    loginOverlay.style.display = "none";
                    document.getElementById("stream-container").style.display = "flex";
                    controlsDiv.style.display = "block";
                } else if (msg.type === "error") {
                    loginStatus.textContent = `Error: ${msg.message}`;
                }
            };
            ws.onclose = () => { statusElement.textContent = "Koneksi Mak Comblang Putus."; };
        }
        btnJoin.onclick = connect;

        // --- FUNGSI INPUT (Gabungan v-PRO) ---
        function sendInput(data) { if (inputChannel && inputChannel.readyState === "open") { inputChannel.send(JSON.stringify(data)); } }
        function sendKey(action, key) {
            if (activeKeys[key] && action === 'keydown') return;
            if (!activeKeys[key] && action === 'keyup') return;
            activeKeys[key] = (action === 'keydown');
            sendInput({ action: action, key: key });
        }
        function getMouseCoords(e) {
            const rect = videoElement.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            const normX = (clientX - rect.left) / rect.width;
            const normY = (clientY - rect.top) / rect.height;
            if (normX < 0 || normX > 1 || normY < 0 || normY > 1) return null;
            return { x: normX, y: normY }; 
        }

        function startInputListeners() {
            // Mouse/Touch Absolut (Mode Klik)
            document.getElementById("stream-container").addEventListener('pointerdown', (e) => { if (isEditing) return; const coords = getMouseCoords(e); if(coords) sendInput({ action: "mousedown", x: coords.x, y: coords.y }); });
            document.getElementById("stream-container").addEventListener('pointerup', (e) => { if (isEditing) return; sendInput({ action: "mouseup", x: 0, y: 0 }); });
            document.getElementById("stream-container").addEventListener('pointermove', (e) => { if (isEditing) return; if (e.buttons === 1) { const coords = getMouseCoords(e); if(coords) sendInput({ action: "mousemove", x: coords.x, y: coords.y }); } });
            
            // Keyboard & UI Handlers
            hiddenInput.onkeydown = (e) => { e.preventDefault(); sendInput({ action: "keydown", key: e.key }); };
            hiddenInput.onkeyup = (e) => { e.preventDefault(); sendInput({ action: "keyup", key: e.key }); };
            document.onkeydown = (e) => { if (loginOverlay.style.display !== 'none' || settingsModal.style.display === 'block') return; if (document.activeElement !== hiddenInput) { e.preventDefault(); sendInput({ action: "keydown", key: e.key }); } };
            document.onkeyup = (e) => { if (loginOverlay.style.display !== 'none' || settingsModal.style.display === 'block') return; if (document.activeElement !== hiddenInput) { e.preventDefault(); sendInput({ action: "keyup", key: e.key }); } };
            btnKeyboard.onclick = () => { hiddenInput.focus(); };

            // Gamepad Virtual Input
            gamepadButtons.forEach(btn => {
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); sendKey('keydown', `gamepad_${btn.id.split('-')[2]}`); });
                btn.addEventListener('touchend', (e) => { e.preventDefault(); sendKey('keyup', `gamepad_${btn.id.split('-')[2]}`); });
            });
        }
        
        // --- FUNGSI KONTROL UI (Edit, Fullscreen, dll) ---
        btnEditLayout.onclick = () => { /* Logika Edit */ };
        btnFullscreen.onclick = () => { if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } };
        btnSettings.onclick = () => { settingsModal.style.display = 'block'; };
        btnCloseSettings.onclick = () => { settingsModal.style.display = 'none'; };
        window.onload = () => { /* Logika Muat Layout */ };
        
    </script>
</body>
</html>
