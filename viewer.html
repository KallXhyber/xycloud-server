<!DOCTYPE html>
<html>
<head>
    <title>Xycloud Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body, html { background-color: #1a1a1a; color: #fff; margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; -webkit-user-select: none; user-select: none; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1f2937, #111827); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; }
        #login-box { background: #2b2b2b; padding: 30px 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; width: 300px; }
        #login-box h2 { margin: 0 0 25px 0; color: #f0f0f0; }
        #login-box input { display: block; margin: 15px auto; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #333; color: #fff; width: 90%; font-size: 16px; }
        #login-box button { padding: 12px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
        #login-status { color: #ff4d4d; height: 20px; margin-top: 15px; }
        #how-to { color: #aaa; font-size: 12px; margin-top: 20px; cursor: pointer; text-decoration: underline; }
        #footer { color: #777; font-size: 10px; margin-top: 10px; }
        #stream-container { width: 100%; height: 100%; display: none; justify-content: center; align-items: center; }
        /* Ganti <img> jadi <video> */
        #stream { width: 100%; height: 100%; object-fit: contain; cursor: none; }
        #fake-cursor { position: fixed; top: 50%; left: 50%; width: 20px; height: 20px; background: rgba(0, 123, 255, 0.7); border: 2px solid white; border-radius: 10px; transform: translate(-50%, -50%); pointer-events: none; z-index: 1000; display: none; transition: transform 0.05s linear; }
        #status { z-index: 101; position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; }
        #controls { position: fixed; top: 10px; right: 10px; z-index: 50; display: none; }
        #controls button { width: 45px; height: 45px; border-radius: 50%; border: none; background: rgba(0,123,255,0.7); color: white; font-size: 20px; margin-left: 10px; cursor: pointer; }
        #settings-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 20px 30px; border-radius: 12px; z-index: 300; display: none; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; min-width: 300px; }
        .setting-row label { font-size: 16px; margin-right: 15px; }
        #hidden-input { position: absolute; left: -9999px; top: -9999px; opacity: 0; }
        @media (max-width: 800px) and (orientation: portrait) {
            #potrait-lock { display: flex !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #111; color: white; z-index: 500; justify-content: center; align-items: center; text-align: center; }
        }
    </style>
</head>
<body>
    <div id="stream-container">
        <video id="stream" autoplay playsinline></video>
        <audio id="audio" autoplay></audio>
    </div>
    <div id="fake-cursor"></div>
    <div id="status">Memuat...</div>
    <div id="controls">
        <button id="btn-mode">üëÜ</button>
        <button id="btn-keyboard">‚å®Ô∏è</button>
        <button id="btn-settings">‚öôÔ∏è</button>
        <button id="btn-fullscreen">‚õ∂</button>
    </div>
    <div id="settings-modal">
        <h3>Pengaturan</h3>
        <div class="setting-row">
            <label>Kualitas Stream:</label>
            <select id="select-quality" disabled><option>WebRTC Otomatis</option></select>
        </div>
        <hr><button id="btn-close-settings" style="width: 100%;">Tutup Bos</button>
    </div>
    <div id="potrait-lock" style="display: none;"><h1>Bro, Puter HP-nya Dulu! (Horizontal)</h1></div>
    <div id="login-overlay">
        <div id="login-box">
            <h2>Xycloud Login (WebRTC)</h2>
            <input id="input-id" type="text" placeholder="ID Host">
            <input id="input-pass" type="password" placeholder="Password">
            <button id="btn-join">Gasss!</button>
            <div id="login-status"></div>
            <div id="how-to" onclick="alert('1. Buka Xycloud_App di PC lo.\n2. ID & Pass-nya muncul di situ.\n3. Masukin ke sini, klik Gasss!')">Gimana Caranya?</div>
            <div id="footer">Created By XyTeam</div>
        </div>
    </div>
    <input type="text" id="hidden-input">

    <script>
        // --- Elemen Halaman ---
        const videoElement = document.getElementById("stream");
        const audioElement = document.getElementById("audio");
        const statusElement = document.getElementById("status");
        const loginOverlay = document.getElementById("login-overlay");
        const loginStatus = document.getElementById("login-status");
        const btnJoin = document.getElementById("btn-join");
        const inputId = document.getElementById("input-id");
        const inputPass = document.getElementById("input-pass");
        
        const fakeCursor = document.getElementById("fake-cursor");
        const controlsDiv = document.getElementById("controls");
        const btnFullscreen = document.getElementById("btn-fullscreen");
        const btnSettings = document.getElementById("btn-settings");
        const btnKeyboard = document.getElementById("btn-keyboard");
        const btnMode = document.getElementById("btn-mode");
        const hiddenInput = document.getElementById("hidden-input");
        
        const settingsModal = document.getElementById("settings-modal");
        const btnCloseSettings = document.getElementById("btn-close-settings");

        // --- Variabel Global ---
        let ws; // WebSocket (Signaling)
        let pc; // PeerConnection (WebRTC)
        let inputChannel; // DataChannel (Mouse/Keyboard)
        
        let isMobile = ('ontouchstart' in window);
        let inputMode = "touch";
        let lastTouchX = 0, lastTouchY = 0;
        let cursorX = window.innerWidth / 2, cursorY = window.innerHeight / 2;
        let activeKeys = {};

        // --- Alamat Server (Otomatis) ---
        const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const httpProtocol = window.location.protocol;
        const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
        const httpUrl = `${httpProtocol}//${window.location.host}`;

        // --- Fungsi Kirim Data ---
        function sendInput(data) {
            // Kirim lewat DataChannel, bukan WebSocket!
            if (inputChannel && inputChannel.readyState === "open") {
                inputChannel.send(JSON.stringify(data));
            }
        }
        
        // --- Logika Koneksi (WebRTC) ---
        async function connect() {
            const hostId = inputId.value;
            const password = inputPass.value;
            if (!hostId || !password) {
                loginStatus.textContent = "ID/Pass jangan kosong, Bro."; return;
            }
            loginStatus.textContent = "Nyambungin ke Mak Comblang...";
            
            // Buat koneksi WebRTC (PC)
            // (Kita bisa tambahkan STUN/TURN server di sini nanti)
            pc = new RTCPeerConnection();
            
            // Terima Video & Audio
            pc.addTransceiver("video", { direction: "recvonly" });
            pc.addTransceiver("audio", { direction: "recvonly" });

            pc.ontrack = (event) => {
                statusElement.textContent = "Track Diterima! Menunggu video...";
                if (event.track.kind === "video") {
                    videoElement.srcObject = event.streams[0];
                }
                if (event.track.kind === "audio") {
                    audioElement.srcObject = event.streams[0];
                }
            };
            
            // Terima DataChannel (Mouse/Keyboard)
            pc.ondatachannel = (event) => {
                inputChannel = event.channel;
                inputChannel.onopen = () => {
                    console.log("Input Channel TERBUKA!");
                    statusElement.textContent = "STREAMING...";
                };
                inputChannel.onmessage = (e) => console.log(e.data); // Host kirim pesan tes
            };

            // Kirim ICE candidate ke Host via Server
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    fetch(`${httpUrl}/ice-candidate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: hostId, // Kirim ke Host
                            candidate: event.candidate.toJSON()
                        })
                    });
                }
            };

            // --- Logika Signaling (Mak Comblang) ---
            ws = new WebSocket(wsUrl);
            ws.onopen = () => {
                loginStatus.textContent = "Ngomong sama Host...";
                // 1. Daftar ke server sebagai viewer
                ws.send(JSON.stringify({
                    action: "join_viewer",
                    id: `viewer_${Math.random().toString(16).substr(2, 8)}`, // ID acak
                    host_id: hostId,
                    password: password
                }));
            };

            ws.onmessage = async (event) => {
                const msg = JSON.parse(event.data);
                
                if (msg.type === "success") {
                    // Berhasil gabung, kita tunggu 'offer' dari Host
                    loginStatus.textContent = "Sukses! Nunggu 'Offer' dari Host...";
                } 
                else if (msg.type === "offer") {
                    // 2. Terima 'offer' dari Host
                    console.log("Menerima 'offer'");
                    loginStatus.textContent = "Dapet 'Offer', Bikin 'Answer'...";
                    await pc.setRemoteDescription(new RTCSessionDescription(msg));
                    
                    // 3. Buat 'answer'
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    
                    // 4. Kirim 'answer' ke Host via Server
                    await fetch(`${httpUrl}/answer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: hostId, // Kirim ke Host
                            sdp: answer.sdp,
                            type: answer.type
                        })
                    });
                    
                    // Sembunyikan UI Login
                    loginOverlay.style.display = "none";
                    streamContainer.style.display = "flex";
                    controlsDiv.style.display = "block";
                    if (isMobile) fakeCursor.style.display = "block";
                    startInputListeners();
                    
                } 
                else if (msg.type === "ice-candidate") {
                    // Terima kandidat dari Host
                    await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
                }
                else if (msg.type === "error") {
                    loginStatus.textContent = `Error: ${msg.message}`;
                }
            };
            
            ws.onclose = () => {
                statusElement.textContent = "Koneksi Mak Comblang Putus.";
                loginOverlay.style.display = "flex";
                streamContainer.style.display = "none";
                controlsDiv.style.display = "none";
            };
        }
        btnJoin.onclick = connect;

        // --- FUNGSI INPUT (Mouse, Touch, Keyboard) ---
        // (Semua fungsi input (startInputListeners, getMouseCoords, dll)
        // SAMA PERSIS dengan kode `viewer.html` v5/v6.
        // Cukup copy-paste bagian itu ke sini.)
        function sendKey(action, key) {
            if (action === 'keydown' && activeKeys[key]) return;
            if (action === 'keyup' && !activeKeys[key]) return;
            activeKeys[key] = (action === 'keydown');
            sendInput({ action: action, key: key });
        }
        function updateFakeCursor(x, y) {
            if (isMobile) {
                cursorX = x; cursorY = y;
                fakeCursor.style.transform = `translate(${x}px, ${y}px)`;
            }
        }
        function startInputListeners() {
            function getMouseCoords(e) {
                const rect = videoElement.getBoundingClientRect(); // Ganti imgElement
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                const normX = (clientX - rect.left) / rect.width;
                const normY = (clientY - rect.top) / rect.height;
                if (normX < 0 || normX > 1 || normY < 0 || normY > 1) return null;
                return { x: normX, y: normY };
            }
            function onTouchStartAbs(e) { e.preventDefault(); const coords = getMouseCoords(e); if(coords) sendInput({ action: "mousedown", ...coords}); }
            function onTouchMoveAbs(e) { e.preventDefault(); const coords = getMouseCoords(e); if(coords) sendInput({ action: "mousemove", ...coords}); }
            function onTouchStartTrackpad(e) { e.preventDefault(); const touch = e.touches[0]; lastTouchX = touch.clientX; lastTouchY = touch.clientY; isTap = true; }
            function onTouchMoveTrackpad(e) {
                e.preventDefault(); isTap = false; const touch = e.touches[0];
                const dx = (touch.clientX - lastTouchX) * 2;
                const dy = (touch.clientY - lastTouchY) * 2;
                sendInput({ action: "mouse_rel", dx: dx, dy: dy });
                updateFakeCursor(cursorX + dx, cursorY + dy);
                lastTouchX = touch.clientX; lastTouchY = touch.clientY;
            }
            function onTouchEndTrackpad(e) { e.preventDefault(); if (isTap) { sendInput({ action: "mouse_click", button: 'left' }); } }
            streamContainer.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                if(inputMode === 'trackpad') sendInput({ action: "mouse_click", button: 'right' });
            });
            streamContainer.onmousedown = (e) => {
                e.preventDefault();
                const coords = getMouseCoords(e);
                if(coords) sendInput({ action: "mousedown", ...coords });
                if(e.button === 2) { sendInput({ action: "mouse_click", button: 'right' }); }
            };
            streamContainer.onmouseup = (e) => { e.preventDefault(); sendInput({ action: "mouseup", x:0, y:0 }); };
            streamContainer.onmousemove = (e) => {
                e.preventDefault();
                if (e.buttons === 1) { // Hanya jika di-drag
                    const coords = getMouseCoords(e);
                    if(coords) sendInput({ action: "mousemove", ...coords });
                }
            };
            if (isMobile) {
                streamContainer.addEventListener('touchstart', onTouchStartAbs, {passive: false});
                streamContainer.addEventListener('touchmove', onTouchMoveAbs, {passive: false});
            }
            hiddenInput.onkeydown = (e) => { e.preventDefault(); sendKey("keydown", e.key); };
            hiddenInput.onkeyup = (e) => { e.preventDefault(); sendKey("keyup", e.key); };
            document.onkeydown = (e) => {
                if (loginOverlay.style.display !== 'none' || settingsModal.style.display === 'block') return;
                if (document.activeElement !== hiddenInput) { e.preventDefault(); sendKey("keydown", e.key); }
            };
            document.onkeyup = (e) => {
                if (loginOverlay.style.display !== 'none' || settingsModal.style.display === 'block') return;
                if (document.activeElement !== hiddenInput) { e.preventDefault(); sendKey("keyup", e.key); }
            };
            btnMode.onclick = () => {
                if (inputMode === "touch") {
                    inputMode = "trackpad"; btnMode.textContent = "üñ±Ô∏è";
                    streamContainer.removeEventListener('touchstart', onTouchStartAbs);
                    streamContainer.removeEventListener('touchmove', onTouchMoveAbs);
                    streamContainer.addEventListener('touchstart', onTouchStartTrackpad, {passive: false});
                    streamContainer.addEventListener('touchmove', onTouchMoveTrackpad, {passive: false});
                    streamContainer.addEventListener('touchend', onTouchEndTrackpad);
                } else {
                    inputMode = "touch"; btnMode.textContent = "üëÜ";
                    streamContainer.removeEventListener('touchstart', onTouchStartTrackpad);
                    streamContainer.removeEventListener('touchmove', onTouchMoveTrackpad);
                    streamContainer.removeEventListener('touchend', onTouchEndTrackpad);
                    streamContainer.addEventListener('touchstart', onTouchStartAbs, {passive: false});
                    streamContainer.addEventListener('touchmove', onTouchMoveAbs, {passive: false});
                }
            };
            btnKeyboard.onclick = () => { hiddenInput.focus(); };
        }
        btnFullscreen.onclick = () => {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen(); }
            else { document.exitFullscreen(); }
        };
        btnSettings.onclick = () => { settingsModal.style.display = 'block'; };
        btnCloseSettings.onclick = () => { settingsModal.style.display = 'none'; };

    </script>
</body>
</html>
